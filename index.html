<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Interface Mail Assistant</title>
  <style>
    /* Style de base pour le body */
    html, body {
  margin: 0;
  padding: 0;
  min-height: 100vh; /* Assure que le body occupe toute la hauteur de la fenêtre */
}

    body {
  font-family: Arial, sans-serif;
  margin: 20px;
  /* Utilisation d'une image de fond dans le dossier images/ */
  background-image: url('images/imagebackground.jpeg');
  background-size: cover; /* Remplacer 'cover' par 'contain' pour afficher l'image en entier */
  background-position: center;
  background-repeat: no-repeat;
}
    /* Style pour la zone de résumé */
    pre {
      white-space: pre-wrap;
      border: 1px solid #ccc;
      padding: 10px;
      /* Pour rendre le fond semi-transparent afin d'améliorer la lisibilité sur l'image */
      background-color: rgba(249, 249, 249, 0.925);
      font-family: Arial, sans-serif;
      font-size: 16px;
      color: #333;
      /* Coins arrondis et ombre portée */
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.678);
    }
    /* Style pour les boutons */
    button {
      margin: 5px;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      background-color: #007BFF;
      color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      cursor: pointer;
    }
    button:hover {
      background-color: #0069d9;
    }
    /* Zone pour les boutons d'action, initialement masquée */
    #actions {
      display: none;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Résumé généré par l'IA</h1>

  <!-- Bouton pour récupérer le résumé -->
  <button id="get-summary">Obtenir le résumé</button>

  <h2>Résumé :</h2>
  <pre id="resume">Aucun résumé pour l’instant…</pre>
  <h2>ID du mail :</h2>
<pre id="mailId">Aucun ID pour l’instant…</pre>

  <!-- Zone pour les boutons d'action -->
  <div id="actions">
    <h3>Actions :</h3>
    <button id="reply-btn">Répondre</button>
    <button id="delete-btn">Supprimer</button>
    <button id="ignore-btn">Ignorer</button>
  </div>
  <!-- Zone pour l'édition de la réponse (initialement masquée) -->
<div id="edit-section" style="display: none; margin-top: 20px; border: 1px solid #007BFF; padding: 15px; border-radius: 10px; background-color: rgba(230, 240, 255, 0.95);">
  <h3>Éditer et Envoyer la Réponse</h3>
  <p><strong>Destinataire :</strong> <span id="edit-recipient"></span></p>
  <p><strong>Sujet Original :</strong> <span id="edit-subject"></span></p>
  <textarea id="edit-reply-text" rows="10" style="width: 98%; margin-bottom: 10px;" placeholder="Éditez la réponse ici..."></textarea>
  <button id="confirm-send-btn">Envoyer la réponse modifiée</button>
  <button id="cancel-edit-btn" style="background-color: #6c757d;">Annuler</button>
  <!-- Stockage caché des IDs -->
  <input type="hidden" id="edit-gmailId">
  <input type="hidden" id="edit-airtableId">
</div>

  <script>
    const sendWebhookUrl = 'https://misterh06.app.n8n.cloud/webhook/send-final-reply';
    // Variable pour stocker l'ID du mail récupéré (provenant de n8n)
    let currentGmailId = null;

  // --- Nouveaux Event Listeners pour la section d'édition ---

document.getElementById('confirm-send-btn').addEventListener('click', async () => {
  // Récupérer les données nécessaires depuis la section d'édition
  const editedReply = document.getElementById('edit-reply-text').value;
  const recipientEmail = document.getElementById('edit-recipient').textContent;
  const originalSubject = document.getElementById('edit-subject').textContent;
  const gmailId = document.getElementById('edit-gmailId').value;
  const airtableId = document.getElementById('edit-airtableId').value;

  if (!editedReply || !recipientEmail || !originalSubject || !gmailId || !airtableId) {
    alert("Erreur : Toutes les informations nécessaires ne sont pas présentes pour l'envoi.");
    return;
  }

  // Afficher un indicateur de chargement
  document.body.style.cursor = 'wait';
  document.getElementById('confirm-send-btn').disabled = true;
  document.getElementById('cancel-edit-btn').disabled = true;

  try {
    // Appeler le NOUVEAU webhook d'envoi
    const response = await fetch(sendWebhookUrl, { // Utilise l'URL du nouveau webhook
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        editedReply: editedReply,
        recipientEmail: recipientEmail,
        originalSubject: originalSubject,
        gmailId: gmailId,
        airtableId: airtableId
      })
    });

    const result = await response.json();
    console.log("Réponse du webhook d'envoi final :", result);

    // Afficher la confirmation
    const messageToShow = result.message || JSON.stringify(result);
    alert("Envoi final terminé. Résultat : " + messageToShow);

    // Cacher la section d'édition et réinitialiser (par exemple, réafficher les actions)
    document.getElementById('edit-section').style.display = 'none';
    // Optionnel: Réafficher les actions si pertinent, ou juste laisser vide.
    // document.getElementById('actions').style.display = 'block';
    // Optionnel: Effacer le résumé et l'ID affichés ?
    // document.getElementById('resume').textContent = "Aucun résumé pour l’instant…";
    // document.getElementById('mailId').textContent = "Aucun ID pour l’instant…";
    // currentGmailId = null;


  } catch (error) {
    console.error("Erreur lors de l'envoi final :", error);
    alert("Échec de l'envoi final. Vérifiez la console.");
  } finally {
    // Toujours remettre l'interface à la normale
    document.body.style.cursor = 'default';
     // Réactiver les boutons si nécessaire, dépend de la réinitialisation souhaitée
     document.getElementById('confirm-send-btn').disabled = false;
     document.getElementById('cancel-edit-btn').disabled = false;
  }
});

document.getElementById('cancel-edit-btn').addEventListener('click', () => {
  // Cacher la section d'édition
  document.getElementById('edit-section').style.display = 'none';
  // Réafficher les actions initiales
  document.getElementById('actions').style.display = 'block';
   // S'assurer que le bouton reply est réactivé s'il avait été désactivé
   const replyButton = document.getElementById('reply-btn');
   if(replyButton) replyButton.disabled = false;
});






        // ----- DÉBUT DE LA FONCTION MODIFIÉE -----
        async function envoyerAction(command) {
      if (!currentGmailId) {
        alert("Aucun ID de mail disponible.");
        return;
      }
      if (command === 'DELETE') {
        const confirmer = confirm("Voulez-vous vraiment supprimer cet email ?");
        if (!confirmer) return;
      }

      // Mettre un indicateur de chargement et désactiver le bouton cliqué
      document.body.style.cursor = 'wait';
      const targetButton = document.getElementById(command.toLowerCase() + '-btn');
      if(targetButton) targetButton.disabled = true;

      try {
        const response = await fetch('https://misterh06.app.n8n.cloud/webhook/3251383a-01dc-495b-bf2c-ebe6b9de960e', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: command,
            gmailMessageId: currentGmailId
          })
        });

        // Essayer de toujours parser comme JSON
        const result = await response.json();
        console.log("Réponse reçue pour", command, ":", result);

        // ----- NOUVELLE LOGIQUE ICI -----
        if (command === 'REPLY' && result.status === 'suggestion_ready') {
          // CAS 1: C'est une suggestion de réponse, on affiche l'éditeur

          console.log("Suggestion reçue, préparation de l'éditeur.");

          // Cacher les boutons d'action normaux
          document.getElementById('actions').style.display = 'none';

          // Remplir les champs de la section d'édition avec les données reçues de n8n
          // Assure-toi que les IDs dans getElementById correspondent bien à ton HTML
          document.getElementById('edit-recipient').textContent = result.recipientEmail || 'Non trouvé';
          document.getElementById('edit-subject').textContent = result.originalSubject || 'Non trouvé';
          document.getElementById('edit-reply-text').value = result.suggestedReply || ''; // Utilise .value pour textarea
          document.getElementById('edit-gmailId').value = result.gmailId || ''; // Stocke les IDs dans les champs cachés
          document.getElementById('edit-airtableId').value = result.airtableId || '';

          // Afficher la section d'édition
          document.getElementById('edit-section').style.display = 'block';

          // Remettre le curseur à la normale (car on reste sur la page)
          document.body.style.cursor = 'default';
          // Le bouton 'Répondre' (targetButton) reste désactivé pour l'instant,
          // l'utilisateur interagira avec les boutons de la section d'édition.

          // Pas besoin de 'return;' ici si on veut que la suite (rien pour l'instant) s'exécute

        } else {
          // CAS 2: Pour DELETE, IGNORE, ou si REPLY n'a pas renvoyé une suggestion valide

          // Affiche le message venant de n8n (qui devrait être dans result.message)
          const messageToShow = result.message || JSON.stringify(result); // Prend le message si dispo, sinon tout l'objet
          alert("Action '" + command + "' terminée. Résultat : " + messageToShow);

          // Remettre le curseur et réactiver le bouton SEULEMENT pour DELETE/IGNORE
           if (command !== 'REPLY') {
               document.body.style.cursor = 'default';
               if(targetButton) targetButton.disabled = false;
           } else {
               // Si c'était REPLY mais sans suggestion, on remet juste le curseur
               // mais on laisse le bouton 'Répondre' désactivé pour éviter confusion.
               document.body.style.cursor = 'default';
           }
        }
        // ----- FIN DE LA NOUVELLE LOGIQUE -----

      } catch (error) {
        console.error("Erreur lors de l'envoi de l'action :", error);
        alert("Échec de l'envoi de l'action '" + command + "'. Vérifiez la console pour les détails.");
        // Assurer la remise à zéro en cas d'erreur
        document.body.style.cursor = 'default';
        if(targetButton) targetButton.disabled = false;
      }
    }
    // ----- FIN DE LA FONCTION MODIFIÉE -----

    // Attacher les événements aux boutons d'action
    document.getElementById('reply-btn').addEventListener('click', () => envoyerAction('REPLY'));
    document.getElementById('delete-btn').addEventListener('click', () => envoyerAction('DELETE'));
    document.getElementById('ignore-btn').addEventListener('click', () => envoyerAction('IGNORE'));
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Interface Mail Assistant</title>
  <style>
    /* ... (Tes styles restent inchangés) ... */
    html, body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-image: url('images/imagebackground.jpeg');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }
    pre {
      white-space: pre-wrap;
      border: 1px solid #ccc;
      padding: 10px;
      background-color: rgba(249, 249, 249, 0.925);
      font-family: Arial, sans-serif;
      font-size: 16px;
      color: #333;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.678);
    }
    button {
      margin: 5px;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      background-color: #007BFF;
      color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      cursor: pointer;
    }
    button:hover {
      background-color: #0069d9;
    }
    #actions {
      display: none;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Résumé généré par l'IA</h1>

  <button id="get-summary">Obtenir le résumé</button>

  <h2>Résumé :</h2>
  <pre id="resume">Aucun résumé pour l’instant…</pre>
  <h2>ID du mail :</h2>
  <pre id="mailId">Aucun ID pour l’instant…</pre>

  <div id="actions">
    <h3>Actions :</h3>
    <button id="reply-btn">Répondre</button>
    <button id="delete-btn">Supprimer</button>
    <button id="ignore-btn">Ignorer</button>
  </div>

  <script>
    let currentGmailId = null;

    document.getElementById('get-summary').addEventListener('click', async () => {
      // --- Ton code existant pour get-summary reste identique ---
      try {
        const response = await fetch('https://misterh06.app.n8n.cloud/webhook/e55fe17f-6985-4fb3-98f6-68beab2ed656', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'fetch' })
        });
        let data = await response.json();
        console.log("Type de données reçues :", typeof data);
        if (typeof data === "string") {
          try {
             data = JSON.parse(data);
          } catch(e) {
            console.error("Impossible de parser la réponse en JSON:", data);
            document.getElementById('resume').textContent = "Erreur lors de l'interprétation de la réponse.";
            return; // Arrêter si on ne peut pas parser
          }
        }
        const dataObj = Array.isArray(data) ? data[0] : data;
        console.log("Données après parsing :", dataObj);

        // Assurer que dataObj est un objet avant d'accéder aux propriétés
        if (typeof dataObj !== 'object' || dataObj === null) {
             console.error("Les données reçues ne sont pas un objet valide:", dataObj);
             document.getElementById('resume').textContent = "Format de réponse inattendu.";
             return;
        }

        const resumeText = dataObj.resume ? dataObj.resume.replace(/[{}]/g, '') : "Résumé non trouvé.";
        document.getElementById('resume').textContent = resumeText;

        const mailId = dataObj.gmailMessageId ? dataObj.gmailMessageId.replace(/[{}]/g, '') : null;
        currentGmailId = mailId;
        document.getElementById('mailId').textContent = mailId || "Aucun ID pour l’instant...";

        document.getElementById('actions').style.display = 'block';
      } catch (error) {
        console.error("Erreur :", error);
        document.getElementById('resume').textContent = "Erreur lors de la requête.";
      }
      // --- Fin du code get-summary ---
    });

    // Fonction pour envoyer une commande d'action vers n8n
    async function envoyerAction(command) {
      if (!currentGmailId) {
        alert("Aucun ID de mail disponible.");
        return;
      }
      if (command === 'DELETE') {
        const confirmer = confirm("Voulez-vous vraiment supprimer cet email ?");
        if (!confirmer) return;
      }

      // Mettre un indicateur de chargement (optionnel mais recommandé)
      document.body.style.cursor = 'wait'; // Change le curseur
      const targetButton = document.getElementById(command.toLowerCase() + '-btn');
      if(targetButton) targetButton.disabled = true; // Désactive le bouton cliqué

      try {
        const response = await fetch('https://misterh06.app.n8n.cloud/webhook/3251383a-01dc-495b-bf2c-ebe6b9de960e', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: command,
            gmailMessageId: currentGmailId
          })
        });

        // Essayer de toujours parser comme JSON, car n8n devrait envoyer JSON maintenant
        const result = await response.json();
        console.log("Réponse reçue pour", command, ":", result);

        // ----- MODIFICATION IMPORTANTE ICI -----
        if (command === 'REPLY' && result.status === 'pending_edit' && result.editUrl) {
          // Si c'est une réponse et qu'on a l'URL d'édition, on redirige
          alert("Préparation de l'éditeur de réponse..."); // Message informatif
          window.location.href = result.editUrl; // Redirection vers la page d'édition
          // Pas besoin de réactiver le bouton ou le curseur ici car on change de page
          return; // Sortir de la fonction après redirection
        } else {
          // Pour DELETE, IGNORE, ou si REPLY n'a pas renvoyé d'URL d'édition
          // Affiche le message venant de n8n (qui devrait être dans result.message)
          const messageToShow = result.message || JSON.stringify(result); // Prend le message si dispo, sinon tout l'objet
          alert("Action '" + command + "' terminée. Résultat : " + messageToShow);
        }
        // ----- FIN DE LA MODIFICATION -----

      } catch (error) {
        console.error("Erreur lors de l'envoi de l'action :", error);
        alert("Échec de l'envoi de l'action '" + command + "'. Vérifiez la console pour les détails.");
      } finally {
         // Remettre l'interface à la normale SEULEMENT si on n'a pas redirigé
         if (command !== 'REPLY') { // Ne pas exécuter si on redirige
            document.body.style.cursor = 'default';
            if(targetButton) targetButton.disabled = false;
         }
      }
    }

    // Attacher les événements aux boutons d'action
    document.getElementById('reply-btn').addEventListener('click', () => envoyerAction('REPLY'));
    document.getElementById('delete-btn').addEventListener('click', () => envoyerAction('DELETE'));
    document.getElementById('ignore-btn').addEventListener('click', () => envoyerAction('IGNORE'));
  </script>
</body>
</html>